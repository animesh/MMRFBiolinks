---
title: "Analyzing and visualizing MMRF-COMMPASS data"
package: MMRFBiolinks
output:
  BiocStyle::html_document
abstract: |
  Description of your vignette
vignette: |
  %\VignetteIndexEntry{5. Analyzing and visualizing MMRF-COMMPASS data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r setup}
library(MMRFBiolinks)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
library(TCGAbiolinks)
library(SummarizedExperiment)
library(dplyr)
library(DT)
library(png)
library(grid)
```

# Analyze data from MMRF-COMMPASS database available at GDC Data Portal 
You can easily prepare data for analysis using MMRFGDC_prepare. MMRFGDC_prepare must be used  in conjuction with GDCquery, GDCdownload and TCGAanalyze_Preprocessing functions belonging to TCGABiolinks package:

## `MMRFGDC_prepare`: reads the downloaded data and prepare them into an R object for the next analysis


You can easily search TCGA samples, download and prepare a matrix of gene expression.

```{r results='hide', echo=TRUE, message=FALSE, warning=FALSE}


# You can define a list of samples to query and download providing relative TCGA barcodes.
listSamples <- c("MMRF_2473","MMRF_2111",
                 "MMRF_2362","MMRF_1824",
                 "MMRF_1458","MRF_1361",
                 "MMRF_2203","MMRF_2762",
                 "MMRF_2680","MMRF_1797")

# Query platform Illumina HiSeq with a list of barcode 
query <- GDCquery(project = "MMRF-COMMPASS", 
                  data.category = "Transcriptome Profiling",
                  data.type = "Gene Expression Quantification",
                  experimental.strategy = "RNA-Seq",
                  workflow.type="HTSeq - FPKM",
                  barcode = listSamples)

# Download 
GDCdownload(query)

# Prepare expression matrix with geneID in the rows and samples (barcode) in the columns

MMRnaseqSE <- MMRFGDC_prepare(query,
                              save = TRUE ,
                              save.filename = "RNASeqSE.rda" ,
                              directory = "GDCdata",
                              summarizedExperiment = TRUE)

 
 

 
 
# For gene expression if you need to see a boxplot correlation and AAIC plot to define outliers you can run
MMRFdataPrepro <- TCGAanalyze_Preprocessing(MMRnaseqSE)
```





```{r, fig.width=6, fig.height=4, echo=FALSE, fig.align="center"}
img <- readPNG("MMRF_PreprocessingOutput.png")
grid.raster(img)
```


## `MMRFanalyzeGDC_SurvivalKM`: Correlating gene expression and Survival Analysis

```{r results='hide', echo=TRUE, message=FALSE, warning=FALSE}

clin.mm <- MMRFqueryGDC_clinic(type = "clinical")


#MMRnaseqSE is a matrix of Gene expression (genes in rows, samples in cols) from MMRFGDC_prepare




tokenStop<- 1

tabSurvKMcomplete <- NULL

for( i in 1: round(nrow(MMRFdataPrepro)/500)){
    message( paste( i, "of ", round(nrow(MMRFdataPrepro)/100)))
    tokenStart <- tokenStop
    tokenStop <-100*i
    tabSurvKM <- MMRFanalyzeGDC_SurvivalKM(clin.mm,
                                        MMRFdataPrepro,
                                        Genelist = rownames(MMRFdataPrepro)[tokenStart:tokenStop],
                                        Survresult = F,ThreshTop=0.76,ThreshDown=0.33)
    tabSurvKMcomplete <- rbind(tabSurvKMcomplete,tabSurvKM)
}

tabSurvKMcomplete <- tabSurvKMcomplete[tabSurvKMcomplete$pvalue < 0.01,]


```


```{r  echo=TRUE, message=FALSE, warning=FALSE}


tabSurvKMcomplete %>% datatable(options = list(scrollX = TRUE, keys = TRUE))

```











# Analyze clinical data downloaded from MMRF-Commpass Researcher Gateway 
You can easily analyze data using following functions:

## `MMRFgetGateway_BestOverallResponsePlot`: draw plot of the Best Overall Response to the Treatment


```{r, eval = FALSE}
MMRFgetGateway_BestOverallResponsePlot(clinMMGateway)

```


```{r, fig.width=7, fig.height=8, echo=FALSE, fig.align="center"}
img <- readPNG("MMRF_TreatResp.png")
grid.raster(img)
```

```{r, eval = FALSE}

MMRFgetGateway_BestOverallResponsePlot(clinMMGateway,"Bortezomib")

```
```{r, fig.width=6, fig.height=4, echo=FALSE, fig.align="center"}
img <- readPNG("MMRF_TreatRespFilt.png")
grid.raster(img)
```
